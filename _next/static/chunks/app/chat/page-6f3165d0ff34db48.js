(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[929],{3656:function(e,t,s){Promise.resolve().then(s.bind(s,5055))},5055:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return m}});var o=s(7437),n=s(2265);function a(){let[e,t]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{let e="true"===localStorage.getItem("darkMode")||window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;t(e),e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")},[]),(0,o.jsx)("button",{onClick:()=>{let s=!e;t(s),localStorage.setItem("darkMode",s.toString()),s?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")},className:"p-[2px] rounded-md hover:bg-gray-200 dark:hover:bg-gray-700",title:e?"Switch to light mode":"Switch to dark mode",children:e?(0,o.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,o.jsx)("circle",{cx:"12",cy:"12",r:"5"}),(0,o.jsx)("line",{x1:"12",y1:"1",x2:"12",y2:"3"}),(0,o.jsx)("line",{x1:"12",y1:"21",x2:"12",y2:"23"}),(0,o.jsx)("line",{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}),(0,o.jsx)("line",{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}),(0,o.jsx)("line",{x1:"1",y1:"12",x2:"3",y2:"12"}),(0,o.jsx)("line",{x1:"21",y1:"12",x2:"23",y2:"12"}),(0,o.jsx)("line",{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}),(0,o.jsx)("line",{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"})]}):(0,o.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,o.jsx)("path",{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"})})})}function l(e){let{collapsed:t,setCollapsed:s,openSettings:l}=e,[i,r]=(0,n.useState)("gpt"),[d,c]=(0,n.useState)("API Key Reqd for ChatGPT"),[g,m]=(0,n.useState)(!1),[h,p]=(0,n.useState)("ChatGPT 4o Mini"),[u,w]=(0,n.useState)({gpt:[],claude:[],gemini:[]}),[x,v]=(0,n.useState)(null);(0,n.useEffect)(()=>{let e=localStorage.getItem("gpt-api-key"),t=localStorage.getItem("claude-api-key"),s=localStorage.getItem("gpt-model")||"gpt-4o-mini",o=localStorage.getItem("claude-model")||"claude-instant";if("gpt"===i)switch(c(e?"OpenAI API Key set":"API Key Reqd for OpenAI"),s){case"gpt-4o-mini":p("ChatGPT 4o Mini");break;case"gpt-3.5-turbo":p("ChatGPT 3.5 Turbo");break;case"gpt-4":p("ChatGPT 4");break;case"gpt-4-turbo":p("ChatGPT 4 Turbo");break;case"gpt-4o":p("ChatGPT 4o");break;default:p("ChatGPT")}else if("claude"===i)switch(c(t?"Anthropic API Key set":"API Key Reqd for Anthropic"),o){case"claude-instant":p("Claude Instant");break;case"claude-3-haiku":p("Claude 3 Haiku");break;case"claude-3-sonnet":p("Claude 3 Sonnet");break;case"claude-3-opus":p("Claude 3 Opus");break;default:p("Claude")}else c("Gemini Flash 2.0 (Free)"),p("Gemini Flash 2.0")},[i]),(0,n.useEffect)(()=>{let e=()=>{try{let e=localStorage.getItem("currentSessionId");if(e){if(e&&"gpt"===localStorage.getItem("selectedModel")&&!e.startsWith("gpt-separator-")){console.log("Found malformed GPT session ID in localStorage:",e);let t="gpt-separator-".concat(Date.now(),"-corrected");localStorage.setItem("currentSessionId",t),console.log("Corrected session ID to:",t),v(t)}else v(e),console.log("Sidebar loaded currentSessionId from localStorage:",e)}let t=JSON.parse(localStorage.getItem("gpt-messages")||"[]"),s=JSON.parse(localStorage.getItem("claude-messages")||"[]"),o=JSON.parse(localStorage.getItem("gemini-messages")||"[]"),n=[...t],a=!1;if(n.length>0){"system"===n[0].role&&"--- New Chat ---"===n[0].content||(n=[{role:"system",content:"--- New Chat ---",id:"gpt-separator-".concat(Date.now(),"-first"),timestamp:n[0].timestamp||Date.now()},...n],a=!0);let e=!1,t=-1;n=n.map((s,o)=>{if("system"===s.role&&"--- New Chat ---"===s.content){if(t=o,!s.id||!s.id.startsWith("gpt-separator-"))return e=!0,{...s,id:"gpt-separator-".concat(Date.now(),"-").concat(o),timestamp:s.timestamp||Date.now()};if(!s.timestamp)return e=!0,{...s,timestamp:Date.now()}}return s}),-1!==t&&t===n.length-1&&(n[t].timestamp=Date.now(),e=!0),e&&(a=!0),a&&(console.log("Fixed GPT messages structure:",n),localStorage.setItem("gpt-messages",JSON.stringify(n)))}let l=JSON.parse(localStorage.getItem("message-timestamps")||"{}"),i=y(a?n:t,"gpt",l),r=y(s,"claude",l),d=y(o,"gemini",l);if(w({gpt:i,claude:r,gemini:d}),!x&&!e){console.log("No currentSessionId, attempting to select the most recent conversation");let e=localStorage.getItem("selectedModel")||"gpt",t=[];switch(e){case"gpt":t=i;break;case"claude":t=r;break;case"gemini":t=d}if(t.length>0){let e=[...t].sort((e,t)=>(t.timestamp||0)-(e.timestamp||0))[0];if(e&&e.id){console.log("Automatically selecting most recent session:",e.id),v(e.id),localStorage.setItem("currentSessionId",e.id);let t=new CustomEvent("sessionChanged",{detail:{sessionId:e.id}});window.dispatchEvent(t),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50)}}}if(e){let t=localStorage.getItem("selectedModel")||"gpt";if("gpt"===t&&!e.startsWith("gpt-separator-")&&(console.log("Stored session ID is malformed:",e),i.length>0)){let e=i[0];if(e&&e.id){console.log("Using first GPT session instead:",e.id),v(e.id),localStorage.setItem("currentSessionId",e.id);let t=new CustomEvent("sessionChanged",{detail:{sessionId:e.id}});window.dispatchEvent(t),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50)}}}}catch(e){console.error("Error loading chat history:",e)}};e();let t=()=>{e()};window.addEventListener("storage",t);let s=()=>{e()};window.addEventListener("messagesUpdated",s);let o=e=>{e.detail&&e.detail.sessionId&&(console.log("Sidebar received sessionChanged event with ID:",e.detail.sessionId),v(e.detail.sessionId))};return window.addEventListener("sessionChanged",o),()=>{window.removeEventListener("storage",t),window.removeEventListener("messagesUpdated",s),window.removeEventListener("sessionChanged",o)}},[x]),(0,n.useEffect)(()=>{let e=()=>{"gpt"===i?localStorage.getItem("gpt-model")&&r(e=>"gpt"===e?(setTimeout(()=>r("gpt"),0),"gpt-temp"):e):"claude"===i&&localStorage.getItem("claude-model")&&r(e=>"claude"===e?(setTimeout(()=>r("claude"),0),"claude-temp"):e)};return window.addEventListener("storage",e),()=>{window.removeEventListener("storage",e)}},[i]),(0,n.useEffect)(()=>{"gpt-temp"!==i&&"claude-temp"!==i&&localStorage.setItem("selectedModel",i)},[i]);let f=e=>{switch(e){case"gpt":return"bg-green-500";case"claude":return"bg-orange-500";case"gemini":return"bg-blue-500";default:return"bg-gray-500"}},y=(e,t,s)=>{if(!e||0===e.length)return[];if("gpt"===t&&e.length>0){let t=e[0];if(!("system"===t.role&&"--- New Chat ---"===t.content)){console.log("First GPT message is not a separator, fixing...");let s=[{role:"system",content:"--- New Chat ---",id:"gpt-separator-".concat(Date.now()),timestamp:t.timestamp||Date.now()},...e];localStorage.setItem("gpt-messages",JSON.stringify(s)),e=s}}let o=[],n=[],a=0,l=null;return e.forEach((e,s)=>{"system"===e.role&&"--- New Chat ---"===e.content?(n.length>0&&l&&o.push({messages:n,timestamp:a,modelType:t,id:l}),n=[],l=e.id,a=e.timestamp||Date.now(),"gpt"===t&&l&&!l.startsWith("gpt-separator-")&&(l="gpt-separator-".concat(Date.now(),"-").concat(s),e.id=l,console.log("Fixed malformed GPT session ID to: ".concat(l))),l||(l="".concat(t,"-separator-").concat(Date.now(),"-").concat(s),e.id=l,console.log("Created missing session ID: ".concat(l))),console.log("Session separator found with ID: ".concat(l,", timestamp: ").concat(a))):(l&&"gpt"===t&&(e.sessionId=l),n.push(e))}),n.length>0&&l&&o.push({messages:n,timestamp:a,modelType:t,id:l}),o},S=e=>{if(!e||!e.messages||0===e.messages.length)return"New Chat";let t=e.messages.find(e=>"user"===e.role);if(!t)return"New Chat";let s=t.content;return s.length>25&&(s=s.substring(0,25)+"..."),s},b=(e,t)=>{console.log("selectSession called with:",{model:e,index:t}),console.log("Current chatHistory state:",u),r(e),localStorage.setItem("selectedSessionIndex",t.toString()),localStorage.setItem("selectedSessionModel",e);let s=u[e][t];if(console.log("Session to select:",s),s&&s.id){var o;let n=s.id;if(console.log("Selected session with ID:",n),"gpt"===e&&!n.startsWith("gpt-separator-")){let e=n;n="gpt-separator-".concat(Date.now(),"-").concat(t),console.log("Correcting malformed GPT session ID from ".concat(e," to ").concat(n));try{let t=JSON.parse(localStorage.getItem("gpt-messages")||"[]"),s=!1,o=t.map(t=>t.id===e&&"system"===t.role&&"--- New Chat ---"===t.content?(s=!0,{...t,id:n}):t);s&&(localStorage.setItem("gpt-messages",JSON.stringify(o)),console.log("Updated message separator ID in storage"))}catch(e){console.error("Error updating GPT message ID:",e)}}v(n),localStorage.setItem("currentSessionId",n);let a=s.messages&&s.messages.length>0;if(console.log("Session has messages:",a,"count:",(null===(o=s.messages)||void 0===o?void 0:o.length)||0),"gpt"===e)try{let e=JSON.parse(localStorage.getItem("gpt-messages")||"[]"),t=!1;for(let s=0;s<e.length;s++){let o=e[s];if(o.id===n&&"system"===o.role&&"--- New Chat ---"===o.content){t=!0;break}}if(!t&&s.messages.length>0){console.log("Session separator not found directly, trying to match by content...");for(let o=0;o<e.length;o++){let a=e[o];if("system"===a.role&&"--- New Chat ---"===a.content){let l=!0,i=Math.min(s.messages.length,e.length-o-1);for(let t=0;t<i&&!(o+1+t>=e.length)&&!(t>=s.messages.length);t++)if(s.messages[t].content!==e[o+1+t].content){l=!1;break}if(l&&i>0){let e=a.id;console.log("Found matching session by content, ID:",e),n=e,v(e),localStorage.setItem("currentSessionId",e),t=!0;break}}}}if(!t){console.log("Could not find or match GPT session, creating a new one");let t="gpt-separator-".concat(Date.now(),"-new"),s=[...e,{role:"system",content:"--- New Chat ---",id:t,timestamp:Date.now()}];localStorage.setItem("gpt-messages",JSON.stringify(s)),n=t,v(t),localStorage.setItem("currentSessionId",t);let o=new CustomEvent("newChat",{detail:{model:"gpt",sessionId:t}});window.dispatchEvent(o),setTimeout(()=>{window.dispatchEvent(new Event("forceRender")),window.dispatchEvent(new Event("messagesUpdated"))},100);return}}catch(e){console.error("Error handling GPT session selection:",e)}let l=new CustomEvent("loadSession",{detail:{model:e,sessionId:n,hasMessages:a}});window.dispatchEvent(l);let i=new CustomEvent("sessionChanged",{detail:{sessionId:n,hasMessages:a}});window.dispatchEvent(i),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50)}else if(console.error("No session ID found for session:",s),console.log("Attempting fallback for missing session ID"),"gpt"===e&&s&&s.messages&&s.messages.length>0){let t="gpt-separator-".concat(Date.now());console.log("Created fallback session ID:",t),localStorage.setItem("currentSessionId",t),v(t);let s=new CustomEvent("loadSession",{detail:{model:e,sessionId:t,hasMessages:!0,isFallback:!0}});window.dispatchEvent(s);let o=new CustomEvent("sessionChanged",{detail:{sessionId:t,hasMessages:!0,isFallback:!0}});window.dispatchEvent(o),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50)}},I=!t||g;return(0,o.jsxs)("div",{className:"sidebar-container ".concat(I?"w-64":"w-0"," transition-all duration-300 ease-in-out relative"),onMouseLeave:()=>m(!1),children:[(0,o.jsxs)("div",{className:"sidebar fixed h-full bg-slate-50 dark:bg-gray-800 border-r dark:border-gray-700 p-4 flex flex-col ".concat(I?"w-64 opacity-100":"w-0 opacity-0 overflow-hidden"),onMouseEnter:()=>m(!0),children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,o.jsx)("h1",{className:"text-xl font-bold",children:"Chat"}),(0,o.jsxs)("div",{className:"flex items-center gap-[2px]",children:[(0,o.jsx)(a,{}),(0,o.jsx)("button",{className:"p-[2px] rounded-md hover:bg-gray-200 dark:hover:bg-gray-700",onClick:l,title:"Settings",children:(0,o.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,o.jsx)("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),(0,o.jsx)("circle",{cx:"12",cy:"12",r:"3"})]})}),(0,o.jsx)("button",{className:"p-[2px] rounded-md hover:bg-gray-200 dark:hover:bg-gray-700",onClick:()=>s(!t),title:t?"Pin sidebar":"Unpin sidebar",children:t?(0,o.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.25",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,o.jsx)("line",{x1:"5",y1:"12",x2:"19",y2:"12"}),(0,o.jsx)("polyline",{points:"14 7 19 12 14 17"}),(0,o.jsx)("line",{x1:"19",y1:"4",x2:"19",y2:"20",strokeOpacity:"0.8"})]}):(0,o.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.25",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,o.jsx)("line",{x1:"19",y1:"12",x2:"5",y2:"12"}),(0,o.jsx)("polyline",{points:"10 7 5 12 10 17"}),(0,o.jsx)("line",{x1:"5",y1:"4",x2:"5",y2:"20",strokeOpacity:"0.8"})]})})]})]}),(0,o.jsxs)("div",{className:"mb-6",children:[(0,o.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Select Model"}),(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)("div",{className:"w-1 h-6 rounded-sm ".concat(f(i))}),(0,o.jsxs)("select",{className:"flex-1 rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 p-2",value:i,onChange:e=>{let t=e.target.value;r(t);let s=new CustomEvent("modelChanged",{detail:{model:t}});if(window.dispatchEvent(s),u[t]&&u[t].length>0){let e=[...u[t]].sort((e,t)=>(t.timestamp||0)-(e.timestamp||0))[0];if(e&&e.id){console.log("Automatically selecting most recent ".concat(t," session:"),e.id);let s=u[t].findIndex(t=>t.id===e.id);if(-1!==s){v(e.id),localStorage.setItem("currentSessionId",e.id),localStorage.setItem("selectedSessionIndex",s.toString()),localStorage.setItem("selectedSessionModel",t);let o=new CustomEvent("sessionChanged",{detail:{sessionId:e.id}});window.dispatchEvent(o);let n=new CustomEvent("loadSession",{detail:{model:t,sessionId:e.id,hasMessages:e.messages&&e.messages.length>0}});window.dispatchEvent(n),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50);return}}}if(0===u[t].length){console.log("No conversations found for ".concat(t,", creating a new one"));let e="".concat(t,"-separator-").concat(Date.now()),s=new CustomEvent("newChat",{detail:{model:t,sessionId:e}});window.dispatchEvent(s)}},children:[(0,o.jsx)("option",{value:"gpt",children:"OpenAI (API Key)"}),(0,o.jsx)("option",{value:"claude",children:"Anthropic (API Key)"}),(0,o.jsx)("option",{value:"gemini",children:"Gemini Flash 2.0 (Free)"})]})]}),(0,o.jsxs)("div",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:["Using: ",h]})]}),(0,o.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,o.jsxs)("button",{className:"w-full text-left px-4 py-2 mb-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md flex items-center",onClick:()=>{localStorage.removeItem("selectedSessionIndex"),localStorage.removeItem("selectedSessionModel");let e="".concat(i,"-separator-").concat(Date.now());v(e);let t=new CustomEvent("newChat",{detail:{model:i,sessionId:e}});window.dispatchEvent(t);let s=new CustomEvent("sessionChanged",{detail:{sessionId:e}});window.dispatchEvent(s),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100)},children:[(0,o.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,o.jsx)("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),(0,o.jsx)("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"New Chat"]}),(0,o.jsxs)("div",{className:"space-y-1",children:[(0,o.jsx)("h3",{className:"text-xs uppercase text-gray-500 dark:text-gray-400 font-semibold px-2 mb-2",children:"Chat History"}),(()=>{let e=[...u.gpt.map((e,t)=>({...e,index:t,model:"gpt"})),...u.claude.map((e,t)=>({...e,index:t,model:"claude"})),...u.gemini.map((e,t)=>({...e,index:t,model:"gemini"}))];console.log("Session timestamps before sorting:",e.map(e=>({model:e.model,id:e.id,index:e.index,timestamp:e.timestamp,title:S(e).substring(0,15)+"..."})));let t=e.sort((e,t)=>{let s=(t.timestamp||0)-(e.timestamp||0);return 0!==s?s:e.model!==t.model?e.model.localeCompare(t.model):e.index-t.index});return(console.log("Session timestamps after sorting:",t.map(e=>({model:e.model,id:e.id,index:e.index,timestamp:e.timestamp,title:S(e).substring(0,15)+"...",isActive:x===e.id}))),0===t.length)?(0,o.jsx)("div",{className:"text-sm text-gray-500 dark:text-gray-400 text-center px-2",children:"No chat history yet"}):t.map((e,t)=>{let s=x===e.id,n="".concat(e.model,"-").concat(e.index,"-").concat(e.id||Date.now()+t);return(0,o.jsxs)("div",{className:"flex items-center px-2 py-2 my-1 rounded-md cursor-pointer transition-colors duration-150 ".concat(s?"bg-gray-200 dark:bg-gray-700 border-l-2 border-gray-500":"hover:bg-gray-100 dark:hover:bg-gray-800"),onClick:()=>{console.log("Selecting session:",e),b(e.model,e.index)},children:[(0,o.jsx)("div",{className:"w-1 h-5 rounded-sm mr-2 ".concat(f(e.model))}),(0,o.jsx)("div",{className:"flex-1 text-sm truncate",children:S(e)})]},n)})})()]})]}),(0,o.jsx)("div",{className:"mt-auto pt-4 border-t dark:border-gray-700",children:(0,o.jsx)("div",{className:"text-sm text-amber-600 dark:text-amber-400 text-center",children:d})})]}),t&&(0,o.jsx)("div",{className:"fixed top-0 left-0 w-16 h-full z-10",onMouseEnter:()=>m(!0)})]})}function i(e){let{onClose:t}=e,[s,a]=(0,n.useState)(""),[l,i]=(0,n.useState)(""),[r,d]=(0,n.useState)("gpt"),[c,g]=(0,n.useState)("gpt-4o-mini"),[m,h]=(0,n.useState)("claude-instant"),p=(0,n.useRef)(null);return(0,n.useEffect)(()=>{a(localStorage.getItem("gpt-api-key")||""),i(localStorage.getItem("claude-api-key")||""),d(localStorage.getItem("selectedModel")||"gpt"),g(localStorage.getItem("gpt-model")||"gpt-4o-mini"),h(localStorage.getItem("claude-model")||"claude-instant");let e=e=>{"Escape"===e.key&&t()},s=e=>{p.current&&!p.current.contains(e.target)&&t()};return document.addEventListener("keydown",e),document.addEventListener("mousedown",s),()=>{document.removeEventListener("keydown",e),document.removeEventListener("mousedown",s)}},[t]),(0,o.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,o.jsxs)("div",{ref:p,className:"bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md",children:[(0,o.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,o.jsx)("h2",{className:"text-xl font-bold",children:"API Key Settings"}),(0,o.jsx)("button",{onClick:t,className:"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300","aria-label":"Close",children:(0,o.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,o.jsx)("path",{d:"M18 6 6 18"}),(0,o.jsx)("path",{d:"m6 6 12 12"})]})})]}),(0,o.jsxs)("div",{className:"space-y-6",children:["gpt"===r&&(0,o.jsxs)("div",{className:"space-y-4",children:[(0,o.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,o.jsx)("label",{htmlFor:"gpt-key",className:"text-right",children:"OpenAI API Key"}),(0,o.jsx)("input",{id:"gpt-key",type:"password",className:"col-span-3 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600",placeholder:"sk-...",value:s,onChange:e=>a(e.target.value)})]}),(0,o.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,o.jsx)("label",{htmlFor:"gpt-model",className:"text-right",children:"Model"}),(0,o.jsxs)("select",{id:"gpt-model",className:"col-span-3 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600",value:c,onChange:e=>g(e.target.value),children:[(0,o.jsx)("option",{value:"gpt-4o-mini",children:"GPT-4o Mini"}),(0,o.jsx)("option",{value:"gpt-3.5-turbo",children:"GPT-3.5 Turbo"}),(0,o.jsx)("option",{value:"gpt-4",children:"GPT-4"}),(0,o.jsx)("option",{value:"gpt-4-turbo",children:"GPT-4 Turbo"}),(0,o.jsx)("option",{value:"gpt-4o",children:"GPT-4o"})]})]}),(0,o.jsx)("div",{className:"col-span-4 text-xs text-gray-500 dark:text-gray-400 text-right",children:"GPT-4o Mini and GPT-3.5 Turbo are more cost-effective options"})]}),"claude"===r&&(0,o.jsxs)("div",{className:"space-y-4",children:[(0,o.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,o.jsx)("label",{htmlFor:"claude-key",className:"text-right",children:"Anthropic API Key"}),(0,o.jsx)("input",{id:"claude-key",type:"password",className:"col-span-3 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600",placeholder:"sk-ant-...",value:l,onChange:e=>i(e.target.value)})]}),(0,o.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,o.jsx)("label",{htmlFor:"claude-model",className:"text-right",children:"Model"}),(0,o.jsxs)("select",{id:"claude-model",className:"col-span-3 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600",value:m,onChange:e=>h(e.target.value),children:[(0,o.jsx)("option",{value:"claude-instant",children:"Claude Instant"}),(0,o.jsx)("option",{value:"claude-3-haiku",children:"Claude 3 Haiku"}),(0,o.jsx)("option",{value:"claude-3-sonnet",children:"Claude 3 Sonnet"}),(0,o.jsx)("option",{value:"claude-3-opus",children:"Claude 3 Opus"})]})]}),(0,o.jsx)("div",{className:"col-span-4 text-xs text-gray-500 dark:text-gray-400 text-right",children:"Claude Instant is the most cost-effective option"})]}),"gemini"===r&&(0,o.jsxs)("div",{className:"p-4 bg-gray-100 dark:bg-gray-700 rounded-md",children:[(0,o.jsx)("p",{className:"text-sm",children:"Gemini Flash 2.0 Experimental is available for free through Google AI Studio."}),(0,o.jsx)("p",{className:"text-sm mt-2",children:"No API key required for this model."})]})]}),(0,o.jsx)("div",{className:"mt-6 flex justify-end",children:(0,o.jsx)("button",{onClick:()=>{localStorage.setItem("gpt-api-key",s),localStorage.setItem("claude-api-key",l),localStorage.setItem("gpt-model",c),localStorage.setItem("claude-model",m),t()},className:"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white px-4 py-2 rounded-md",children:"gemini"===r?"OK":"Save changes"})})]})})}function r(e){let{children:t}=e,[s,a]=(0,n.useState)(!1),[r,d]=(0,n.useState)(!1);return(0,o.jsxs)("div",{className:"flex h-screen bg-white dark:bg-gray-900 dark:text-white",children:[(0,o.jsx)(l,{collapsed:r,setCollapsed:d,openSettings:()=>a(!0)}),(0,o.jsx)("main",{className:"flex-1 flex flex-col",children:t}),s&&(0,o.jsx)(i,{onClose:()=>a(!1)})]})}function d(e){let{role:t,content:s,modelType:a="gpt"}=e,[l,i]=(0,n.useState)(!1),r="user"===t;return(0,o.jsxs)("div",{className:"message ".concat(r?"user-message":"assistant-message"," mb-4 relative group"),children:[(0,o.jsx)("div",{className:"px-4 py-2 rounded-lg ".concat(r?"bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200":"bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200"),children:s}),(0,o.jsx)("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,o.jsx)("button",{onClick:()=>{navigator.clipboard.writeText(s).then(()=>{i(!0),setTimeout(()=>i(!1),2e3)})},className:"p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700",title:"Copy to clipboard",children:l?(0,o.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,o.jsx)("path",{d:"M20 6 9 17l-5-5"})}):(0,o.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,o.jsx)("rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2"}),(0,o.jsx)("path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"})]})})})]})}function c(e){let{messages:t,isLoading:s,modelType:a="gpt",currentSessionId:l}=e,i=(0,n.useRef)(null),[r,c]=(0,n.useState)(a),[g,m]=(0,n.useState)(l);(0,n.useEffect)(()=>{console.log("modelType changed to:",a),c(a)},[a]),(0,n.useEffect)(()=>{console.log("currentSessionId changed to:",l),l&&(m(l),localStorage.setItem("currentSessionId",l))},[l]),(0,n.useEffect)(()=>{i.current&&(i.current.scrollTop=i.current.scrollHeight)},[t]),(0,n.useEffect)(()=>{let e=e=>{e.detail&&e.detail.sessionId&&(console.log("Session changed event received with ID:",e.detail.sessionId),m(e.detail.sessionId),localStorage.setItem("currentSessionId",e.detail.sessionId))},t=()=>{console.log("Force render event received"),c(e=>e)};return window.addEventListener("sessionChanged",e),window.addEventListener("forceRender",t),()=>{window.removeEventListener("sessionChanged",e),window.removeEventListener("forceRender",t)}},[]);let h=()=>{switch(console.log("getWelcomeMessage called with currentModelType:",r),r){case"gpt":return"Welcome to ChatGPT";case"claude":return"Welcome to Claude";case"gemini":return"Welcome to Gemini";default:return"Welcome to Chat"}};return(0,o.jsxs)("div",{ref:i,className:"chat-container flex-1 space-y-4 p-4 overflow-y-auto",children:[(()=>{if(console.log("renderMessages called with:"),console.log("- localCurrentSessionId:",g),console.log("- currentModelType:",r),console.log("- Total messages:",t.length),!t||0===t.length){let e=h();return console.log("Rendering welcome message (no messages):",e),(0,o.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,o.jsxs)("div",{className:"text-center max-w-md",children:[(0,o.jsx)("h2",{className:"text-2xl font-bold mb-2",children:e}),(0,o.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:"Type a message below to start chatting!"})]})})}if(console.log("All separators:",t.filter(e=>"system"===e.role&&"--- New Chat ---"===e.content).map(e=>e.id)),g){console.log("Specific session selected with ID:",g),"gpt"!==a||g.startsWith("gpt-separator-")||console.log("Detected malformed GPT session ID:",g);let e=t.filter(e=>e.sessionId===g||"system"===e.role&&"--- New Chat ---"===e.content&&e.id===g||!!("gpt"===a&&"system"===e.role&&"--- New Chat ---"===e.content&&e.id&&e.id.includes(g.split("-").pop()))&&(console.log("Found matching GPT separator by ID fragment:",e.id),!0));if(e.length>0){if(console.log("Found messages with matching sessionId:",e.length),1===e.length&&"system"===e[0].role&&"--- New Chat ---"===e[0].content){let e=h();return console.log("Rendering welcome message (empty session):",e),(0,o.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,o.jsxs)("div",{className:"text-center max-w-md",children:[(0,o.jsx)("h2",{className:"text-2xl font-bold mb-2",children:e}),(0,o.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:"Type a message below to start chatting!"})]})})}let t=e.filter(e=>!("system"===e.role&&"--- New Chat ---"===e.content));return console.log("Rendering specific session messages:",t.length),t.map((e,t)=>(0,o.jsx)(d,{role:e.role,content:e.content,modelType:e.modelType||r},"".concat(g,"-").concat(t)))}let s=t.findIndex(e=>"system"===e.role&&"--- New Chat ---"===e.content&&e.id===g);if(-1===s&&"gpt"===a){let e=g.split("-").pop();if(e&&-1!==(s=t.findIndex(t=>"system"===t.role&&"--- New Chat ---"===t.content&&t.id&&t.id.includes(e)))){console.log("Found separator using ID fragment matching:",t[s].id);let e=new CustomEvent("sessionChanged",{detail:{sessionId:t[s].id}});window.dispatchEvent(e)}}if(-1===s&&"gpt"===a){let e=t.map((e,t)=>({msg:e,idx:t})).filter(e=>"system"===e.msg.role&&"--- New Chat ---"===e.msg.content);if(e.length>0){console.log("Attempting content-based matching for GPT session"),s=e[0].idx;let t=e[0].msg.id;if(t){let e=new CustomEvent("sessionChanged",{detail:{sessionId:t}});window.dispatchEvent(e)}}}if(-1!==s){console.log("Found separator at index:",s);let e=-1;for(let o=s+1;o<t.length;o++)if("system"===t[o].role&&"--- New Chat ---"===t[o].content){e=o;break}-1===e&&(e=t.length),console.log("Session range:",s+1,"to",e);let n=t.slice(s+1,e);if(console.log("Session messages:",n),0===n.length){let e=h();return console.log("Rendering welcome message (empty session):",e),(0,o.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,o.jsxs)("div",{className:"text-center max-w-md",children:[(0,o.jsx)("h2",{className:"text-2xl font-bold mb-2",children:e}),(0,o.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:"Type a message below to start chatting!"})]})})}return console.log("Rendering specific session messages:",n.length),n.map((e,t)=>(0,o.jsx)(d,{role:e.role,content:e.content,modelType:e.modelType||r},"".concat(g,"-").concat(t)))}console.warn("Session ID not found:",g)}let e=t[t.length-1];if(e&&"system"===e.role&&"--- New Chat ---"===e.content){let e=h();return console.log("Rendering welcome message (new empty chat):",e),(0,o.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,o.jsxs)("div",{className:"text-center max-w-md",children:[(0,o.jsx)("h2",{className:"text-2xl font-bold mb-2",children:e}),(0,o.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:"Type a message below to start chatting!"})]})})}let s=0,n=null;for(let e=t.length-1;e>=0;e--)if("system"===t[e].role&&"--- New Chat ---"===t[e].content){s=e+1,n=t[e].id;break}console.log("Showing most recent conversation starting at index:",s),console.log("Most recent separator ID:",n);let l=t.slice(s);if(0===l.length){let e=h();return console.log("Rendering welcome message (empty recent conversation):",e),(0,o.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,o.jsxs)("div",{className:"text-center max-w-md",children:[(0,o.jsx)("h2",{className:"text-2xl font-bold mb-2",children:e}),(0,o.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:"Type a message below to start chatting!"})]})})}return l.map((e,t)=>(0,o.jsx)(d,{role:e.role,content:e.content,modelType:e.modelType||r},n?"".concat(n,"-").concat(t):"current-".concat(t)))})(),s&&(0,o.jsx)("div",{className:"assistant-message flex items-center",children:(0,o.jsx)("div",{className:"loading"})})]})}function g(e){let{onSendMessage:t,isLoading:s}=e,[a,l]=(0,n.useState)(""),i=(0,n.useRef)(null);(0,n.useEffect)(()=>{i.current&&(i.current.style.height="auto",i.current.style.height="".concat(Math.min(i.current.scrollHeight,200),"px"))},[a]);let r=e=>{e.preventDefault(),a.trim()&&!s&&(t(a),l(""),i.current&&(i.current.style.height="auto"))};return(0,o.jsx)("div",{className:"border-t dark:border-gray-700 p-4 mt-auto",children:(0,o.jsxs)("form",{onSubmit:r,className:"message-input-container",children:[(0,o.jsx)("textarea",{ref:i,className:"w-full min-h-[48px] p-3 pr-12 border rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600",placeholder:"Type your message...",value:a,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),r(e))},disabled:s,rows:1}),(0,o.jsx)("button",{type:"submit",className:"send-button-claude",disabled:s||!a.trim(),"aria-label":"Send message",children:(0,o.jsxs)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,o.jsx)("circle",{cx:"12",cy:"12",r:"10",fill:a.trim()?"#4B5563":"#9CA3AF"}),(0,o.jsx)("path",{d:"M12 16V8M8 12l4-4 4 4",stroke:"white",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})})]})})}function m(){let[e,t]=(0,n.useState)([]),[s,a]=(0,n.useState)([]),[l,i]=(0,n.useState)([]),[d,m]=(0,n.useState)(!1),[h,p]=(0,n.useState)("gpt"),[u,w]=(0,n.useState)("gpt-4o-mini"),[x,v]=(0,n.useState)("claude-instant"),[f,y]=(0,n.useState)(null),[S,b]=(0,n.useState)({});(0,n.useEffect)(()=>{let e=localStorage.getItem("selectedModel"),s=localStorage.getItem("gpt-model"),o=localStorage.getItem("claude-model"),n=localStorage.getItem("message-timestamps"),l=localStorage.getItem("gpt-messages"),r=localStorage.getItem("claude-messages"),d=localStorage.getItem("gemini-messages"),c=e||"gpt";if(p(c),s&&w(s),o&&v(o),n)try{b(JSON.parse(n))}catch(e){console.error("Error parsing stored timestamps:",e)}let g=[],m=[],h=[];if(l)try{g=JSON.parse(l),t(g)}catch(e){console.error("Error parsing stored GPT messages:",e)}if(r)try{m=JSON.parse(r),a(m)}catch(e){console.error("Error parsing stored Claude messages:",e)}if(d)try{h=JSON.parse(d),i(h)}catch(e){console.error("Error parsing stored Gemini messages:",e)}setTimeout(()=>{let e=localStorage.getItem("currentSessionId");if(e)console.log("Found stored currentSessionId:",e),y(e),setTimeout(()=>{let t=new CustomEvent("sessionChanged",{detail:{sessionId:e,model:c}});window.dispatchEvent(t),window.dispatchEvent(new Event("forceRender")),window.dispatchEvent(new Event("messagesUpdated"))},100);else{let e=[];switch(c){case"gpt":e=g;break;case"claude":e=m;break;case"gemini":e=h}if(e.length>0)for(let t=e.length-1;t>=0;t--){let s=e[t];if("system"===s.role&&"--- New Chat ---"===s.content&&s.id){console.log("Found most recent separator with ID:",s.id),y(s.id),localStorage.setItem("currentSessionId",s.id),setTimeout(()=>{let e=new CustomEvent("sessionChanged",{detail:{sessionId:s.id,model:c}});window.dispatchEvent(e),window.dispatchEvent(new Event("forceRender")),window.dispatchEvent(new Event("messagesUpdated"))},100);break}}else{console.log("No messages found for selected model, creating initial chat");let e="".concat(c,"-separator-").concat(Date.now()),t=new CustomEvent("newChat",{detail:{model:c,sessionId:e}});window.dispatchEvent(t),console.log("Dispatched initial newChat event with ID:",e)}}},50)},[]);let I=(e,t)=>"".concat(e,"-").concat(t);(0,n.useEffect)(()=>{let o=e=>{if("selectedModel"===e.key)p(e.newValue||"gpt");else if("gpt-model"===e.key)w(e.newValue||"gpt-4o-mini");else if("claude-model"===e.key)v(e.newValue||"claude-instant");else if("message-timestamps"===e.key)try{b(JSON.parse(e.newValue||"{}"))}catch(e){console.error("Error parsing stored timestamps:",e)}},n=t=>{console.log("handleModelChange called with model:",t.detail.model),p(t.detail.model);let o=[];switch(t.detail.model){case"gpt":o=e;break;case"claude":o=s;break;case"gemini":o=l;break;default:console.error("Unknown model:",t.detail.model);return}let n=o.slice().reverse().find(e=>"system"===e.role&&"--- New Chat ---"===e.content);if(n){console.log("Found last separator with ID:",n.id),y(n.id),console.log("Current session ID set by handleModelChange to:",n.id);let e=new CustomEvent("sessionChanged",{detail:{sessionId:n.id,model:t.detail.model}});window.dispatchEvent(e),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50)}else if(console.log("No separator found for model:",t.detail.model),y(null),console.log("Current session ID reset to null by handleModelChange"),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50),0===o.length){console.log("No messages found for model, creating new chat");let e="".concat(t.detail.model,"-separator-").concat(Date.now()),s=new CustomEvent("newChat",{detail:{model:t.detail.model,sessionId:e}});window.dispatchEvent(s)}},r=o=>{var n,r;let d=(null===(n=o.detail)||void 0===n?void 0:n.model)||h,c=(null===(r=o.detail)||void 0===r?void 0:r.sessionId)||"".concat(d,"-separator-").concat(Date.now());console.log("handleNewChat called with model:",d,"sessionId:",c);let g=[];switch(d){case"gpt":(g=[...e]).push({role:"system",content:"--- New Chat ---",id:c,timestamp:Date.now()}),localStorage.setItem("gpt-messages",JSON.stringify(g)),t(g);break;case"claude":(g=[...s]).push({role:"system",content:"--- New Chat ---",id:c,timestamp:Date.now()}),localStorage.setItem("claude-messages",JSON.stringify(g)),a(g);break;case"gemini":(g=[...l]).push({role:"system",content:"--- New Chat ---",id:c,timestamp:Date.now()}),localStorage.setItem("gemini-messages",JSON.stringify(g)),i(g)}y(c),console.log("Current session ID set by handleNewChat to:",c);let m=new CustomEvent("sessionChanged",{detail:{sessionId:c,model:d}});window.dispatchEvent(m),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50),window.dispatchEvent(new Event("messagesUpdated"))},d=e=>{let{model:s,sessionId:o,hasMessages:n,isFallback:a}=e.detail;if(console.log("Loading session:",o,"for model:",s,"has messages:",n,"isFallback:",a),!o){console.error("No sessionId provided to handleLoadSession");return}p(s),y(o),localStorage.setItem("currentSessionId",o),console.log("Current session ID set to:",o);let l=[];switch(s){case"gpt":l=JSON.parse(localStorage.getItem("gpt-messages")||"[]");break;case"claude":l=JSON.parse(localStorage.getItem("claude-messages")||"[]");break;case"gemini":l=JSON.parse(localStorage.getItem("gemini-messages")||"[]");break;default:console.error("Unknown model:",s);return}if(a&&"gpt"===s&&(console.log("Handling fallback GPT session..."),!l.some(e=>e.id===o))){console.log("Creating new separator for fallback session");let e=[...l,{role:"system",content:"--- New Chat ---",id:o,timestamp:Date.now()}];localStorage.setItem("gpt-messages",JSON.stringify(e)),t(e),setTimeout(()=>{window.dispatchEvent(new Event("forceRender")),window.dispatchEvent(new Event("messagesUpdated"))},100);return}let i=l.findIndex(e=>e.id===o);if(-1!==i){if(console.log("Found session at index:",i),"gpt"===s&&0===i&&(console.log("Special handling for first GPT session"),!("system"===l[i].role&&"--- New Chat ---"===l[i].content))){console.log("First message is not a separator, adding one...");let e=[{role:"system",content:"--- New Chat ---",id:o,timestamp:Date.now()},...l];localStorage.setItem("gpt-messages",JSON.stringify(e)),t(e),setTimeout(()=>{window.dispatchEvent(new Event("forceRender")),window.dispatchEvent(new Event("messagesUpdated"))},100);return}let e=i<l.length-1;if(console.log("Has messages after separator:",e),"gpt"===s&&(!l[i].timestamp||0===l[i].timestamp)){console.log("Fixing missing timestamp for GPT session");let e=[...l];e[i]={...e[i],timestamp:Date.now()},localStorage.setItem("gpt-messages",JSON.stringify(e)),t(e)}let n=new CustomEvent("sessionChanged",{detail:{sessionId:o,model:s,hasMessages:e}});window.dispatchEvent(n),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100)}else{if(console.error("Session not found:",o,"in model:",s),"gpt"===s){console.log("Session not found for GPT, creating a new one...");let e=[...l,{role:"system",content:"--- New Chat ---",id:o,timestamp:Date.now()}];localStorage.setItem("gpt-messages",JSON.stringify(e)),t(e),setTimeout(()=>{window.dispatchEvent(new Event("forceRender")),window.dispatchEvent(new Event("messagesUpdated"))},100);return}let e=new CustomEvent("sessionChanged",{detail:{sessionId:o,model:s,hasMessages:!1}});window.dispatchEvent(e),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100)}},c=e=>{if(e.detail&&e.detail.sessionId){let t=e.detail.sessionId;f!==t&&(console.log("Session changed from",f,"to",t),y(t),setTimeout(()=>{window.dispatchEvent(new Event("forceRender"))},50))}};return window.addEventListener("storage",o),window.addEventListener("modelChanged",n),window.addEventListener("newChat",r),window.addEventListener("loadSession",d),window.addEventListener("sessionChanged",c),()=>{window.removeEventListener("storage",o),window.removeEventListener("modelChanged",n),window.removeEventListener("newChat",r),window.removeEventListener("loadSession",d),window.removeEventListener("sessionChanged",c)}},[e,s,l,h]),(0,n.useEffect)(()=>{if(localStorage.setItem("gpt-messages",JSON.stringify(e)),localStorage.setItem("selectedModel",h),localStorage.setItem("message-timestamps",JSON.stringify(S)),"gpt"===h){let e=setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100);return()=>clearTimeout(e)}},[e,h,S]),(0,n.useEffect)(()=>{if(localStorage.setItem("claude-messages",JSON.stringify(s)),"claude"===h){let e=setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100);return()=>clearTimeout(e)}},[s,h]),(0,n.useEffect)(()=>{if(localStorage.setItem("gemini-messages",JSON.stringify(l)),"gemini"===h){let e=setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100);return()=>clearTimeout(e)}},[l,h]),(0,n.useEffect)(()=>{f&&(localStorage.setItem("currentSessionId",f),console.log("Stored currentSessionId in localStorage:",f))},[f]),(0,n.useEffect)(()=>{let e=localStorage.getItem("currentSessionId");e&&(console.log("Loaded currentSessionId from localStorage:",e),y(e))},[]),(0,n.useEffect)(()=>{console.log("currentSessionId changed to:",f)},[f]);let E=()=>{let t=Date.now();switch(h){case"gpt":return e.map((e,s)=>({...e,modelType:"gpt",id:e.id||I("gpt",s),timestamp:e.timestamp||S[e.id]||t}));case"claude":return s.map((e,s)=>({...e,modelType:"claude",id:e.id||I("claude",s),timestamp:e.timestamp||S[e.id]||t}));case"gemini":return l.map((e,s)=>({...e,modelType:"gemini",id:e.id||I("gemini",s),timestamp:e.timestamp||S[e.id]||t}));default:return[]}},k=(e,s)=>{if(!e)return;console.log("Updating timestamp for ".concat(s," session ").concat(e));let o=Date.now();try{let n="".concat(s,"-messages"),l=JSON.parse(localStorage.getItem(n)||"[]"),r=!1,d=l.map(t=>t.id===e&&"system"===t.role&&"--- New Chat ---"===t.content?(r=!0,console.log("Found and updating separator with ID ".concat(e)),{...t,timestamp:o}):t);switch(r||console.warn("Could not find separator with ID ".concat(e," in ").concat(s," messages")),localStorage.setItem(n,JSON.stringify(d)),s){case"gpt":t(t=>t.map(t=>t.id===e&&"system"===t.role&&"--- New Chat ---"===t.content?{...t,timestamp:o}:t));break;case"claude":a(t=>t.map(t=>t.id===e&&"system"===t.role&&"--- New Chat ---"===t.content?{...t,timestamp:o}:t));break;case"gemini":i(t=>t.map(t=>t.id===e&&"system"===t.role&&"--- New Chat ---"===t.content?{...t,timestamp:o}:t))}}catch(e){console.error("Error updating ".concat(s," timestamp:"),e)}},C=async o=>{console.log("handleSendMessage called with currentSessionId:",f);let n=f;if("gpt"===h&&f&&!f.startsWith("gpt-separator-")){console.log("Detected malformed GPT session ID:",f),console.log("Created replacement session ID:",n="gpt-separator-".concat(Date.now(),"-fixed")),y(n),localStorage.setItem("currentSessionId",n);let s=[...e,{role:"system",content:"--- New Chat ---",id:n,timestamp:Date.now()}];t(s),localStorage.setItem("gpt-messages",JSON.stringify(s));let o=new CustomEvent("sessionChanged",{detail:{sessionId:n}});window.dispatchEvent(o),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated")),window.dispatchEvent(new Event("forceRender"))},100)}let r={role:"user",content:o,modelType:h,id:"".concat(h,"-message-").concat(Date.now()),sessionId:n,timestamp:Date.now()};E(),console.log("Adding message to session:",n);let d=null!==n;switch(console.log("Preserve conversation context:",d),n&&k(n,h),h){case"gpt":(console.log("Sending message to GPT model with conversation context preserved:",d),n&&!(e.length>0&&"system"===e[e.length-1].role&&"--- New Chat ---"===e[e.length-1].content))?(t([...e,r]),console.log("Added message to existing GPT conversation with session ID:",n)):e.length>0&&"system"===e[e.length-1].role&&"--- New Chat ---"===e[e.length-1].content?(t([...e,r]),console.log("Started new GPT conversation because last message was a separator")):(t([...e,r]),console.log("Added message to GPT conversation (fallback case)")),b(e=>({...e,[r.id]:Date.now()})),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100);break;case"claude":(console.log("Sending message to Claude model with conversation context preserved:",d),n&&!(s.length>0&&"system"===s[s.length-1].role&&"--- New Chat ---"===s[s.length-1].content))?(a([...s,r]),console.log("Added message to existing Claude conversation with session ID:",n)):s.length>0&&"system"===s[s.length-1].role&&"--- New Chat ---"===s[s.length-1].content?(a([...s,r]),console.log("Started new Claude conversation because last message was a separator")):(a([...s,r]),console.log("Added message to Claude conversation (fallback case)")),b(e=>({...e,[r.id]:Date.now()})),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100);break;case"gemini":(console.log("Sending message to Gemini model with conversation context preserved:",d),n&&!(l.length>0&&"system"===l[l.length-1].role&&"--- New Chat ---"===l[l.length-1].content))?(i([...l,r]),console.log("Added message to existing Gemini conversation with session ID:",n)):l.length>0&&"system"===l[l.length-1].role&&"--- New Chat ---"===l[l.length-1].content?(i([...l,r]),console.log("Started new Gemini conversation because last message was a separator")):(i([...l,r]),console.log("Added message to Gemini conversation (fallback case)")),b(e=>({...e,[r.id]:Date.now()})),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100)}m(!0);try{let e="gpt"===h?u:"claude"===h?x:"gemini-flash-2",s=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json","x-gpt-model":u,"x-claude-model":x},body:JSON.stringify({message:o,model:h,apiKey:localStorage.getItem("".concat(h,"-api-key"))||"",modelVersion:e,sessionId:n})});if(!s.ok)throw Error("Failed to send message");let l=await s.json(),r={role:"assistant",content:l.content,modelType:h,id:"".concat(h,"-assistant-").concat(Date.now()),sessionId:n,timestamp:Date.now()};switch(h){case"gpt":t(e=>[...e,r]),b(e=>({...e,[r.id]:Date.now()})),k(n,"gpt"),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100);break;case"claude":a(e=>[...e,r]),b(e=>({...e,[r.id]:Date.now()})),k(n,"claude"),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100);break;case"gemini":i(e=>[...e,r]),b(e=>({...e,[r.id]:Date.now()})),k(n,"gemini"),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100)}}catch(s){console.error("Error sending message:",s);let e={role:"assistant",content:"Sorry, there was an error processing your message. Please try again.",modelType:h,id:"".concat(h,"-error-").concat(Date.now()),sessionId:n,timestamp:Date.now()};switch(h){case"gpt":t(t=>[...t,e]),b(t=>({...t,[e.id]:Date.now()})),k(n,"gpt"),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100);break;case"claude":a(t=>[...t,e]),b(t=>({...t,[e.id]:Date.now()})),k(n,"claude"),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100);break;case"gemini":i(t=>[...t,e]),b(t=>({...t,[e.id]:Date.now()})),k(n,"gemini"),setTimeout(()=>{window.dispatchEvent(new Event("messagesUpdated"))},100)}}finally{m(!1)}};return(0,o.jsx)(r,{children:(0,o.jsxs)("div",{className:"flex flex-col h-full",children:[(0,o.jsx)(c,{messages:E(),isLoading:d,modelType:h,currentSessionId:f},"".concat(h,"-").concat(f)),(0,o.jsx)(g,{onSendMessage:C,isLoading:d})]})})}}},function(e){e.O(0,[971,117,744],function(){return e(e.s=3656)}),_N_E=e.O()}]);