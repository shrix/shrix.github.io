<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: 'rgb(59, 130, 246)',
                            dark: 'rgb(96, 165, 250)'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .chat-container {
            height: calc(100vh - 180px);
            overflow-y: auto;
        }
        .user-message {
            background-color: #e0f2fe;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-left: auto;
            margin-right: 1rem;
            max-width: 80%;
        }
        .assistant-message {
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-right: auto;
            margin-left: 1rem;
            max-width: 80%;
        }
        .dark .user-message {
            background-color: #1e40af;
            color: white;
        }
        .dark .assistant-message {
            background-color: #374151;
            color: white;
        }
        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* New styles for collapsible sidebar */
        .sidebar {
            transition: width 0.3s ease;
            width: 16rem;
        }
        .sidebar.collapsed {
            width: 3rem;
        }
        .sidebar-content {
            opacity: 1;
            transition: opacity 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
        }
        .sidebar.collapsed .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }
        .sidebar-toggle {
            position: absolute;
            top: 1rem;
            right: -2.5rem;
            z-index: 20;
        }
        .sidebar:hover.collapsed {
            width: 16rem;
        }
        .sidebar:hover.collapsed .sidebar-content {
            opacity: 1;
            pointer-events: auto;
        }
        /* Message input with send button inside */
        .message-input-container {
            position: relative;
        }
        .message-input-container textarea {
            padding-right: 3rem;
        }
        .send-button {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: rgb(59, 130, 246);
        }
        .dark .send-button {
            color: rgb(96, 165, 250);
        }
        .send-button:hover {
            color: rgb(37, 99, 235);
        }
        .dark .send-button:hover {
            color: rgb(147, 197, 253);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 dark:text-white">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar bg-slate-50 dark:bg-gray-800 border-r dark:border-gray-700 p-4 flex flex-col relative">
            <!-- Sidebar Toggle Button -->
            <button id="sidebar-toggle" class="sidebar-toggle p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 18l-6-6 6-6"></path>
                </svg>
            </button>

            <div class="sidebar-content">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-xl font-bold">Chat</h1>
                    <button id="theme-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg id="light-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden dark:block">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <svg id="dark-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="block dark:hidden">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">Select Model</label>
                    <select id="model-select" class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 p-2">
                        <option value="gpt">ChatGPT (API Key Required)</option>
                        <option value="claude">Claude (API Key Required)</option>
                        <option value="gemini">Gemini (Free)</option>
                        <option value="grok">Grok (Free)</option>
                    </select>
                </div>

                <div class="flex-1">
                    <button id="new-chat-btn" class="w-full text-left px-4 py-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                        New Chat
                    </button>
                </div>
            </div>

            <!-- Settings Button moved to bottom-right of sidebar -->
            <div class="mt-auto pt-4 border-t dark:border-gray-700 flex flex-col">
                <div id="api-status" class="text-sm text-amber-600 dark:text-amber-400 sidebar-content">API Key required for ChatGPT</div>
                <div class="flex justify-end mt-2">
                    <button id="settings-btn" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings">
                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col relative">
            <!-- Chat Interface -->
            <div class="flex-1 flex flex-col p-4">
                <div id="chat-container" class="chat-container flex-1 space-y-4">
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <h2 class="text-2xl font-bold mb-2">Welcome to Chat</h2>
                            <p class="text-gray-500 dark:text-gray-400">Select a model and start chatting</p>
                        </div>
                    </div>
                </div>

                <div class="border-t dark:border-gray-700 p-4 mt-auto">
                    <div class="message-input-container">
                        <textarea id="message-input" class="w-full min-h-[60px] p-3 border rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" placeholder="Type your message..."></textarea>
                        <button id="send-btn" class="send-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m22 2-7 20-4-9-9-4Z"></path>
                                <path d="M22 2 11 13"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">API Key Settings</h2>
                <button id="close-settings-btn" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-4 items-center gap-4">
                    <label for="gpt-key" class="text-right">ChatGPT API Key</label>
                    <input id="gpt-key" type="password" class="col-span-3 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" placeholder="sk-...">
                </div>
                <div class="grid grid-cols-4 items-center gap-4">
                    <label for="claude-key" class="text-right">Claude API Key</label>
                    <input id="claude-key" type="password" class="col-span-3 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" placeholder="sk-ant-...">
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    <p>Gemini and Grok are available for free and do not require API keys.</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="save-settings-btn" class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white px-4 py-2 rounded-md">Save changes</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://3000-i5et6moeaj341skksxe7o-852cae94.manus.computer/api';

        // State management
        const state = {
            selectedModel: 'gpt',
            messages: [],
            isLoading: false,
            apiKeys: {
                gpt: localStorage.getItem('gpt-api-key') || '',
                claude: localStorage.getItem('claude-api-key') || ''
            },
            sidebarCollapsed: false
        };

        // DOM elements
        const modelSelect = document.getElementById('model-select');
        const newChatBtn = document.getElementById('new-chat-btn');
        const apiStatus = document.getElementById('api-status');
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const gptKeyInput = document.getElementById('gpt-key');
        const claudeKeyInput = document.getElementById('claude-key');
        const themeToggle = document.getElementById('theme-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');

        // Initialize
        function init() {
            modelSelect.value = state.selectedModel;
            updateApiStatus();
            gptKeyInput.value = state.apiKeys.gpt;
            claudeKeyInput.value = state.apiKeys.claude;

            // Check for system dark mode preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }

            // Event listeners
            modelSelect.addEventListener('change', handleModelChange);
            newChatBtn.addEventListener('click', clearMessages);
            messageInput.addEventListener('keydown', handleKeyDown);
            sendBtn.addEventListener('click', handleSendMessage);
            settingsBtn.addEventListener('click', openSettings);
            closeSettingsBtn.addEventListener('click', closeSettings);
            saveSettingsBtn.addEventListener('click', saveSettings);
            themeToggle.addEventListener('click', toggleTheme);
            sidebarToggle.addEventListener('click', toggleSidebar);

            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (e.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }

        // Toggle sidebar
        function toggleSidebar() {
            state.sidebarCollapsed = !state.sidebarCollapsed;
            sidebar.classList.toggle('collapsed', state.sidebarCollapsed);

            // Update toggle button icon
            if (state.sidebarCollapsed) {
                sidebarToggle.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18l6-6-6-6"></path>
                    </svg>
                `;
            } else {
                sidebarToggle.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 18l-6-6 6-6"></path>
                    </svg>
                `;
            }
        }

        // Toggle theme
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
        }

        // Update API status message
        function updateApiStatus() {
            const models = [
                { id: "gpt", name: "ChatGPT", free: false },
                { id: "claude", name: "Claude", free: false },
                { id: "gemini", name: "Gemini", free: true },
                { id: "grok", name: "Grok", free: true },
            ];

            const currentModel = models.find(m => m.id === state.selectedModel) || models[0];
            const needsApiKey = !currentModel.free;
            const hasApiKey = state.apiKeys[state.selectedModel];

            if (needsApiKey && !hasApiKey) {
                apiStatus.textContent = `API Key required for ${currentModel.name}`;
                apiStatus.className = 'text-sm text-amber-600 dark:text-amber-400 sidebar-content';
            } else if (needsApiKey && hasApiKey) {
                apiStatus.textContent = `${currentModel.name} API Key set`;
                apiStatus.className = 'text-sm text-green-600 dark:text-green-400 sidebar-content';
            } else {
                apiStatus.textContent = 'Free access available';
                apiStatus.className = 'text-sm text-green-600 dark:text-green-400 sidebar-content';
            }
        }

        // Handle model change
        function handleModelChange() {
            state.selectedModel = modelSelect.value;
            updateApiStatus();
            clearMessages();
        }

        // Clear messages
        function clearMessages() {
            state.messages = [];
            renderMessages();
        }

        // Handle key down
        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        }

        // Handle send message
        async function handleSendMessage() {
            const content = messageInput.value.trim();
            if (!content || state.isLoading) return;

            // Add user message
            state.messages.push({ role: 'user', content });
            messageInput.value = '';
            renderMessages();

            // Check if API key is required
            const models = [
                { id: "gpt", name: "ChatGPT", free: false },
                { id: "claude", name: "Claude", free: false },
                { id: "gemini", name: "Gemini", free: true },
                { id: "grok", name: "Grok", free: true },
            ];

            const currentModel = models.find(m => m.id === state.selectedModel) || models[0];
            const needsApiKey = !currentModel.free;
            const hasApiKey = state.apiKeys[state.selectedModel];

            if (needsApiKey && !hasApiKey) {
                state.messages.push({
                    role: 'assistant',
                    content: `Error: API key is required for ${currentModel.name}. Please add your API key in settings.`
                });
                renderMessages();
                return;
            }

            // Set loading state
            state.isLoading = true;
            updateSendButton();

            try {
                // Call the backend API
                const response = await fetch(`${API_BASE_URL}/chat/${state.selectedModel}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(needsApiKey && { 'X-API-Key': state.apiKeys[state.selectedModel] })
                    },
                    body: JSON.stringify({ message: content })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get response');
                }

                state.messages.push({ role: 'assistant', content: data.response });
            } catch (error) {
                console.error('Error:', error);

                // Special handling for Gemini API errors
                if (state.selectedModel === 'gemini') {
                    state.messages.push({
                        role: 'assistant',
                        content: `GoogleGenerativeAI Error: The Gemini API is currently experiencing issues. Please try another model or try again later.`
                    });
                } else {
                    state.messages.push({
                        role: 'assistant',
                        content: `Error: ${error.message || 'Something went wrong. Please try again.'}`
                    });
                }
            } finally {
                state.isLoading = false;
                updateSendButton();
                renderMessages();
            }
        }

        // Update send button state
        function updateSendButton() {
            if (state.isLoading) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = `
                    <div class="loading"></div>
                `;
            } else {
                sendBtn.disabled = false;
                sendBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m22 2-7 20-4-9-9-4Z"></path>
                        <path d="M22 2 11 13"></path>
                    </svg>
                `;
            }
        }

        // Render messages
        function renderMessages() {
            if (state.messages.length === 0) {
                chatContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <h2 class="text-2xl font-bold mb-2">Welcome to Chat</h2>
                            <p class="text-gray-500 dark:text-gray-400">Select a model and start chatting</p>
                        </div>
                    </div>
                `;
                return;
            }

            chatContainer.innerHTML = '';
            state.messages.forEach(message => {
                const messageEl = document.createElement('div');
                messageEl.className = message.role === 'user' ? 'user-message' : 'assistant-message';

                const roleEl = document.createElement('div');
                roleEl.className = 'font-medium mb-1';
                roleEl.textContent = message.role === 'user' ? 'You' : state.selectedModel.toUpperCase();

                const contentEl = document.createElement('div');
                contentEl.className = 'whitespace-pre-wrap';
                contentEl.textContent = message.content;

                messageEl.appendChild(roleEl);
                messageEl.appendChild(contentEl);
                chatContainer.appendChild(messageEl);
            });

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Settings functions
        function openSettings() {
            settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            state.apiKeys.gpt = gptKeyInput.value;
            state.apiKeys.claude = claudeKeyInput.value;

            // Save to localStorage
            localStorage.setItem('gpt-api-key', state.apiKeys.gpt);
            localStorage.setItem('claude-api-key', state.apiKeys.claude);

            updateApiStatus();
            closeSettings();
        }

        // Initialize the app
        init();
    </script>
</body>
</html>